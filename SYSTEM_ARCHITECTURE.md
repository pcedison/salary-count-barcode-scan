# 系統架構和設計說明

## 數據庫優先級設計

系統採用 Supabase 作為主要數據庫，同時支持 PostgreSQL 作為備用選項。這種設計有以下優勢：

1. **主數據庫 (Supabase)**
   - 提供雲端存儲，即使 Replit 環境出問題也能保證數據安全
   - 對於多個開發者或安裝者來說，可以輕鬆配置自己的 Supabase 實例
   - 提供自動備份和恢復機制
   - 更高的穩定性和可靠性

2. **備用數據庫 (PostgreSQL)**
   - 在 Supabase 連接失敗時作為備用方案
   - 可以在本地或 Replit 環境中工作
   - 數據存儲在 Replit 環境中

## 監控策略

系統採用經過優化的監控策略，以平衡系統穩定性和性能：

1. **數據庫連接監控**
   - 監控間隔：15 分鐘（原先的 60 秒過於頻繁）
   - 只在必要時執行數據庫查詢
   - 使用輕量級查詢減少系統負擔

2. **故障檢測和自動恢復**
   - 在連接失敗時自動重試
   - 嘗試指定次數後進行故障轉移
   - 記錄故障情況以便後續分析

## 備份改進策略

系統實現了智能備份管理，解決了舊備份清理可能帶來的問題：

1. **多層次備份**
   - 每日備份：保存最近 7 天
   - 每週備份：保存最近 4 週
   - 每月備份：保存最近 12 個月
   - 手動備份：保存最近 30 個

2. **數據完整性驗證**
   - 在刪除舊備份前驗證新備份的有效性
   - 確保至少保留一個有效的備份
   - 使用校驗和確保備份數據完整

3. **數據恢復保障**
   - 支持從任何類型的備份恢復
   - 驗證還原過程中的數據完整性
   - 防止恢復到無效的數據狀態

## 設定持久化策略

系統確保重要設定（如勞健保扣款和管理員密碼）在系統異常時不會丟失：

1. **多重存儲**
   - 數據庫存儲（主要）
   - 文件系統備份（次要）
   - 定期同步確保一致性

2. **自動恢復機制**
   - 系統啟動時檢查設定完整性
   - 當數據庫設定丟失或無效時自動從備份恢復
   - 記錄設定變更以便追蹤

## 系統啟動流程

系統啟動時執行以下步驟，確保穩定性和一致性：

1. 讀取系統配置，確定主數據庫類型和監控策略
2. 初始化數據庫連接，優先使用 Supabase，必要時故障轉移到 PostgreSQL
3. 初始化設定管理器，確保關鍵設定可用
4. 創建啟動時備份，保護當前系統狀態
5. 調整監控間隔至合理水平（15 分鐘）
6. 啟動 Web 服務器和 API

## 長期穩定性保障

為確保系統長期穩定運行，建議以下措施：

1. **定期檢查系統日誌**
   - 識別可能的問題模式
   - 監控數據庫連接和性能

2. **外部備份**
   - 考慮設置自動備份到 Google Drive 或 Dropbox
   - 提供額外的數據保護層

3. **定期系統更新**
   - 保持系統依賴項最新
   - 應用安全和穩定性更新